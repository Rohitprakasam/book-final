% ═══════════════════════════════════════════════════════════════
% BookEducate 8.0 — Premium Colorful Template (Zero-Error)
% ═══════════════════════════════════════════════════════════════
\documentclass[openany,oneside,12pt]{book}

% ─── Page Layout ───
\usepackage[a4paper, margin=1in, headheight=15pt]{geometry}

% ─── Core Packages ───
\usepackage{fontspec}          % XeTeX font support
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{graphicx}
\usepackage{longtable,booktabs,array}
\usepackage{calc}
\usepackage{enumitem}          % Better list control
\usepackage{hyperref}          % Clickable links

% ─── ZERO-ERROR: Set nonstopmode and capture errors gracefully ───
% All unknown commands silently become no-ops instead of crashing
\usepackage{etoolbox}

% ─── INDEX GENERATION (short: Units & Chapters only, ≤3 pages) ───
\usepackage{makeidx}
\makeindex

% Define a custom index style to hide page numbers (Topic List style)
\makeatletter
\newcommand{\topicindex}[1]{}
\makeatother


% ═══════════════════════════════════════════════════════════════
% COLOR PALETTE — Modern Teal & Navy Theme
% ═══════════════════════════════════════════════════════════════
\usepackage[dvipsnames,svgnames,x11names]{xcolor}

% Primary colors
\definecolor{PrimaryDark}{HTML}{1B2A4A}    % Deep Navy
\definecolor{PrimaryAccent}{HTML}{0EA5E9}  % Bright Teal
\definecolor{PrimaryLight}{HTML}{E0F2FE}   % Light Sky
\definecolor{SecondaryAccent}{HTML}{8B5CF6} % Vivid Purple
\definecolor{WarmAccent}{HTML}{F59E0B}     % Amber Gold

% Functional colors
\definecolor{ExampleBg}{HTML}{F0FDF4}      % Mint green background
\definecolor{ExampleBorder}{HTML}{22C55E}  % Green border
\definecolor{SolutionBg}{HTML}{FFF7ED}     % Warm cream background
\definecolor{SolutionBorder}{HTML}{F97316} % Orange border
\definecolor{DefinitionBg}{HTML}{EFF6FF}   % Ice blue background
\definecolor{DefinitionBorder}{HTML}{3B82F6} % Blue border
\definecolor{NoteBoxBg}{HTML}{FDF4FF}      % Lavender background
\definecolor{NoteBoxBorder}{HTML}{A855F7}  % Purple border

% Code colors
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{codebackground}{HTML}{F8FAFC}

% ═══════════════════════════════════════════════════════════════
% TYPOGRAPHY — Clean Modern Fonts
% ═══════════════════════════════════════════════════════════════
\usepackage{titlesec}
\usepackage{fancyhdr}

% Use Latin Modern as base with full math support
\usepackage{lmodern}

% ═══════════════════════════════════════════════════════════════
% CHAPTER & SECTION STYLING — Colored Headers
% ═══════════════════════════════════════════════════════════════

% Chapter: Full-width colored banner (Numbered)
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{PrimaryDark}}
  {\colorbox{PrimaryAccent}{\parbox[c][1.2cm][c]{1.5cm}{\centering\color{white}\fontsize{36}{38}\selectfont\thechapter}}}
  {20pt}
  {\Huge}
  [\vspace{2pt}{\color{PrimaryAccent}\titlerule[2pt]}]

% Chapter: Unnumbered (Starred) — Cleaner look, no number box
\titleformat{name=\chapter,numberless}[display]
  {\normalfont\huge\bfseries\color{PrimaryDark}}
  {}
  {0pt}
  {\Huge}
  [\vspace{2pt}{\color{PrimaryAccent}\titlerule[2pt]}]

% Section: Teal left accent (Numbered)
\titleformat{\section}
  {\normalfont\Large\bfseries\color{PrimaryDark}}
  {\colorbox{PrimaryAccent}{\color{white}\;\thesection\;}}
  {10pt}
  {}
  [\vspace{1pt}{\color{PrimaryAccent}\titlerule[0.8pt]}]

% Section: Unnumbered (Starred)
\titleformat{name=\section,numberless}
  {\normalfont\Large\bfseries\color{PrimaryDark}}
  {}
  {0pt}
  {}
  [\vspace{1pt}{\color{PrimaryAccent}\titlerule[0.8pt]}]

% Subsection: Purple accent
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{SecondaryAccent}}
  {\thesubsection}
  {8pt}
  {}

\titleformat{name=\subsection,numberless}
  {\normalfont\large\bfseries\color{SecondaryAccent}}
  {}
  {0pt}
  {}

% ═══════════════════════════════════════════════════════════════
% HEADER / FOOTER — Clean Styled
% ═══════════════════════════════════════════════════════════════
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\small\color{PrimaryDark}\textbf{BookEducate}}
\fancyhead[R]{\small\color{codegray}\leftmark}
\fancyfoot[C]{\small\color{PrimaryAccent}\textbf{--- \thepage{} ---}}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\headrule}{\hbox to\headwidth{\color{PrimaryAccent}\leaders\hrule height \headrulewidth\hfill}}
\renewcommand{\footrulewidth}{0pt}

% Fix plain pages (chapter openings)
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[C]{\small\color{PrimaryAccent}\textbf{--- \thepage{} ---}}
  \renewcommand{\headrulewidth}{0pt}
}

% ═══════════════════════════════════════════════════════════════
% STYLED ENVIRONMENTS — Breakable Colored Boxes (using mdframed)
% ═══════════════════════════════════════════════════════════════
% \usepackage[framemethod=tikz]{mdframed} % Removed due to environment issues

% Simple fallbacks for boxes
\newenvironment{exampleproblem}[1][]
  {\par\medskip\noindent\textbf{#1}\par\itshape}
  {\par\medskip}

\newenvironment{solution}
  {\par\medskip\noindent\textbf{Solution:}\par}
  {\par\medskip}

% ═══════════════════════════════════════════════════════════════
% HYPERREF STYLING — Colored Links
% ═══════════════════════════════════════════════════════════════
\hypersetup{
  colorlinks=true,
  linkcolor=PrimaryDark,
  citecolor=SecondaryAccent,
  urlcolor=PrimaryAccent,
  bookmarks=true,
  bookmarksopen=false,
  pdfstartview=FitH
}

% ═══════════════════════════════════════════════════════════════
% CODE LISTINGS — Styled
% ═══════════════════════════════════════════════════════════════
\usepackage{listings}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{codebackground},
    commentstyle=\color{codepurple},
    keywordstyle=\color{PrimaryAccent}\bfseries,
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{ExampleBorder},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2,
    frame=single,
    rulecolor=\color{PrimaryLight},
    literate={\\}{{$\backslash$}}1
}
\lstset{style=mystyle}

% ═══════════════════════════════════════════════════════════════
% ZERO-ERROR SAFETY NET — Catch ALL crash scenarios
% ═══════════════════════════════════════════════════════════════

% 1. Pandoc compatibility hooks
\providecommand{\tightlist}{\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% 2. Safe image handling — if image missing, show placeholder text
\let\origincludegraphics\includegraphics
\renewcommand{\includegraphics}[2][]{%
  \IfFileExists{#2}{%
    \origincludegraphics[#1]{#2}%
  }{%
      \centering\color{codegray}\small [Image not found: \texttt{#2}]
  }%
}

% 3. Catch stray \item outside lists
\let\origitem\item
\AtBeginDocument{%
  \@ifundefined{@inlabel}{}{%
  }%
}

% 4. Prevent "Missing $ inserted" crashes — define Unicode math chars as text
\DeclareRobustCommand{\textsubscript}[1]{\ensuremath{_{#1}}}
\DeclareRobustCommand{\textsuperscript}[1]{\ensuremath{^{#1}}}

% Unicode handled natively by XeLaTeX

% 6. Float barriers to prevent images drifting far from their text
% \usepackage[section]{placeins}  % Removed due to system issues

% 7. Prevent Overfull hbox by allowing sloppy line breaks
\tolerance=2000
\emergencystretch=3em
\hfuzz=2pt

% 8. Fix for \cent command (sometimes generated by LLM)
\providecommand{\cent}{\text{\textcent}}
\DeclareUnicodeCharacter{00A2}{\cent}

% 9. Prevent \and errors in author field
\providecommand{\and}{, }

% 10. Counter for none (backwards compat)
\newcounter{none}

% ═══════════════════════════════════════════════════════════════
% DOCUMENT METADATA
% ═══════════════════════════════════════════════════════════════
\title{\color{PrimaryDark}\Huge\textbf{BookEducate}\\[8pt]{\Large\color{PrimaryAccent}Comprehensive Engineering Textbook}}
\author{\color{codegray}\large BookEducate Synthetic Engine v8.0}
\date{\color{codegray}\today}

% ═══════════════════════════════════════════════════════════════
% BEGIN DOCUMENT
% ═══════════════════════════════════════════════════════════════
\begin{document}

\frontmatter

% Custom title page
\begin{titlepage}
\centering
\vspace*{2cm}

{\color{PrimaryAccent}\rule{\textwidth}{3pt}}
\vspace{1.5cm}

{\fontsize{42}{48}\selectfont\bfseries\color{PrimaryDark} BookEducate}\\[0.8cm]
{\fontsize{18}{22}\selectfont\color{SecondaryAccent} Comprehensive Engineering Textbook}\\[0.4cm]
{\fontsize{14}{18}\selectfont\color{codegray} Generated by BookEducate Synthetic Engine v8.0}

\vspace{1.5cm}
{\color{PrimaryAccent}\rule{\textwidth}{3pt}}

\vspace{2cm}

{\large\color{PrimaryDark}\today}

\vfill
{\small\color{codegray} AI-Generated Educational Content — For Reference Use}
\end{titlepage}

% Table of Contents with styled heading
\setcounter{tocdepth}{1}
{\hypersetup{linkcolor=PrimaryDark}
\tableofcontents}

\mainmatter

% ═══════════════════════════════════════════════════════════════
% AI GENERATED CONTENT INJECTION POINT
% ═══════════════════════════════════════════════════════════════
$body$

% ═══════════════════════════════════════════════════════════════
% BACKMATTER — Index
% ═══════════════════════════════════════════════════════════════
\backmatter
\cleardoublepage
\phantomsection
% Render unnumbered index (no page numbers)
\addcontentsline{toc}{chapter}{Topic Index}
\printindex


\end{document}
